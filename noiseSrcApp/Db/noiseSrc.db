############################################################
#
#                   NOISE SOURCE SOFT IOC
#                      RECORD DATABASE
#
############################################################
# LOW LEVEL INFO
#
# Desc: Low level IOCs info.

# Corresponding Noise Generator

record(stringout, "$(P)$(R)NoiseGen-Cte"){
  field(DESC, "Corresponding Noise Generator")
  field(VAL, "$(NOISE_GEN)")
}

# Corresponding Carrier Freq Generator

record(stringout, "$(P)$(R)CarrierGen-Cte"){
  field(DESC, "Corresponding Carrier Freq Generator")
  field(VAL, "$(CARRIER_GEN)")
}

# Carrier generator source 1 status

record(calcout, "$(P)$(R)CarrierGenSrcCalc"){
  field(DESC, "Carrier gen src status calc")
  field(INPA, "$(CARRIER_GEN)Src1PwrOn-Sts CPP")
  field(INPB, "$(CARRIER_GEN)Src2PwrOn-Sts CPP")
  field(INPC, "$(P)$(R)CenterFreqThold-RB CPP")
  field(INPD, "$(P)$(R)CenterFreq-RB CPP")
  field(CALC, "C<D&&(B>0||A=0)?3:(C>=D&&(B=0||A>0)?3:(A>0?1:(B>0?2:0)))")
  field(OUT, "$(P)$(R)CarrierGenSrc-Mon PP")
}

record(mbbi, "$(P)$(R)CarrierGenSrc-Mon"){
  field(ZRST, "None")
  field(ONST, "Src 1")
  field(TWST, "Src 2")
  field(THST, "Src misconfig")
  field(THSV, "MINOR")
}

############################################################
# GENERAL
#
# Desc: General control parameters.

# Enable

record(bo, "$(P)$(R)Enbl-Sel"){
  field(DESC, "Enable noise source")
  field(ZNAM, "Off")
  field(ONAM, "On")
  field(FLNK, "$(P)$(R)CenterFreq-SP")
}

record(calcout, "$(P)$(R)EnblMonCalc"){
  field(DESC, "Calc enable status")
  field(INPA, "$(CARRIER_GEN)Src1PwrOn-Sts CPP")
  field(INPB, "$(CARRIER_GEN)Src2PwrOn-Sts CPP")
  field(INPC, "$(NOISE_GEN)ChanOut-Sts CPP")
  field(CALC, "(A||B)&&C?3:(C>0?1:(A||B?2:0))")
  field(OUT, "$(P)$(R)Enbl-Sts PP")
}

record(mbbi, "$(P)$(R)Enbl-Sts"){
  field(DESC, "Enable noise source status")
  field(ZRST, "Off")
  field(ONST, "Noise gen only")
  field(ONSV, "MINOR")                       # noise gen only = minor alarm
  field(TWST, "Carrier gen only")
  field(TWSV, "MINOR")                       # carrier gen only = minor alarm
  field(THST, "On")
}

############################################################
# WHITE NOISE CONTROL
#
# Desc: Parameters to control noise generator.

# Span

record(ao, "$(P)$(R)Span-SP"){
  field(DESC, "Noise span")
  field(DRVH, "20000000")
  field(DRVL, "0.001")
  field(EGU, "Hz")
  field(OUT, "$(NOISE_GEN)NoiseBw-SP PP")
}

record(ai, "$(P)$(R)Span-RB"){
  field(DESC, "Noise span RB")
  field(EGU, "Hz")
  field(INP, "$(NOISE_GEN)NoiseBw-RB CPP")
}

############################################################
# CARRIER FREQUENCY CONTROL
#
# Desc: Parameters to control the carrier frequency
#       generator.

# Center Frequency

record(ao, "$(P)$(R)CenterFreq-SP"){
  field(DESC, "Noise center freq")
  field(DRVH, "6000")
  field(DRVL, "23.5")
  field(EGU, "MHz")
  field(FLNK, "$(P)$(R)CenterFreqCalc")
}

record(calcout, "$(P)$(R)CenterFreqCalc1"){
  field(DESC, "Calc for selecting carrier output src")
  field(INPA, "$(P)$(R)CenterFreq-SP")
  field(INPB, "$(P)$(R)CenterFreqThold-RB")
  field(CALC, "A<B?3:12")               # A<B ? links 1,2 : links 3,4
  field(FLNK, "$(P)$(R)CenterFreqSeq1")
}

record(seq, "$(P)$(R)CenterFreqSeq1"){
  field(DESC, "Select carrier output src")
  field(SELM, "Mask")
  field(SELL, "$(P)$(R)CenterFreqCalc1")
  field(DO1, "0")
  field(LNK1, "$(CARRIER_GEN)Src2PwrOn-Sel PP")  # Disable src 2 &
  field(DOL2, "$(P)$(R)CenterFreq-SP")
  field(LNK2, "$(CARRIER_GEN)Src1Freq-SP PP")    # Set src 1 freq;
  field(DO3, "0")
  field(LNK3, "$(CARRIER_GEN)Src1PwrOn-Sel PP")  # Disable src 1 &
  field(DOL4, "$(P)$(R)CenterFreq-SP")
  field(LNK4, "$(CARRIER_GEN)Src2Freq-SP PP")    # Set src 2 freq;
  field(FLNK, "$(P)$(R)CenterFreqCalc2")
}

record(calcout, "$(P)$(R)CenterFreqCalc2"){
  field(DESC, "Calc for enabling carrier output src")
  field(INPA, "$(P)$(R)Enbl-Sel")
  field(INPB, "$(P)$(R)CenterFreqCalc1")
  field(CALC, "A>0?(B=12?2:1):12")               # A<B ? links 1 : links 2
  field(FLNK, "$(P)$(R)CenterFreqSeq2")
}

record(seq, "$(P)$(R)CenterFreqSeq2"){
  field(DESC, "Select output src to enable")
  field(SELM, "Mask")
  field(SELL, "$(P)$(R)CenterFreqCalc2")
  field(DO1, "1")
  field(LNK1, "$(CARRIER_GEN)Src1PwrOn-Sel PP")  # Enable src 1;
  field(DO1, "2")
  field(LNK2, "$(CARRIER_GEN)Src2PwrOn-Sel PP")  # Enable src 2;
  field(DO3, "0")
  field(LNK3, "$(CARRIER_GEN)Src1PwrOn-Sel PP")  # Disable src 1 &
  field(DO4, "0")
  field(LNK4, "$(CARRIER_GEN)Src2PwrOn-Sel PP")  # Disable src 2;
}

record(calcout, "$(P)$(R)FreqSrcMonCalc"){
  field(DESC, "Get center freq status from src 1")
  field(INPA, "$(CARRIER_GEN)Src1Freq-RB CPP")
  field(INPB, "$(CARRIER_GEN)Src2Freq-RB CPP")
  field(INPC, "$(CARRIER_GEN)Src1PwrOn-Sts")
  field(INPD, "$(CARRIER_GEN)Src2PwrOn-Sts")
  field(CALC, "C>0||D>0")
  field(OOPT, "When Non-zero")
  field(DOPT, "Use OCAL")
  field(OCAL, "C>0?A:B")
  field(OUT, "$(P)$(R)CenterFreq-RB PP")
}

record(ai, "$(P)$(R)CenterFreq-RB"){
  field(DESC, "Noise center freq RB")
  field(EGU, "MHz")
}

# Center Frequency Threshold
# (used for changing source used)

record(ao, "$(P)$(R)CenterFreqThold-SP"){
  field(DESC, "Freq threshold for changing source")
  field(PINI, "YES")
  field(DRVH, "6000")
  field(DRVL, "23.5")
  field(EGU, "MHz")
  field(FLNK, "$(P)$(R)CenterFreqThold-RB")
}

record(ai, "$(P)$(R)CenterFreqThold-RB"){
  field(DESC, "Freq threshold for changing source RB")
  field(EGU, "MHz")
  field(INP, "$(P)$(R)CenterFreqThold-SP")
}

############################################################
# INITIALIZATION
#
# Desc: Initialization of devices.

# Download

record(bo, "$(P)$(R)Download-Cmd"){
  field(DESC, "Download IOC parameters")
  field(PINI, "YES")
  field(ZNAM, "Off")
  field(ONAM, "On")
  field(HIGH, "2")
  field(VAL, "1")
  field(FLNK, "$(P)$(R)ValidDownload")
}

record(calcout, "$(P)$(R)ValidDownload"){
  field(DESC, "Validate download cmd")
  field(INPA, "$(P)$(R)Download-Cmd")
  field(CALC, "A")
  field(OOPT, "When Non-zero")
  field(OUT, "$(P)$(R)InitSeq1.PROC PP")
}

# Init Noise Gen parameters

record(sseq, "$(P)$(R)InitSeq1"){
  field(DESC, "Init sequence 1")
  field(SELM, "All")
  field(STR1, "Noise")
  field(LNK1, "$(NOISE_GEN)WfmFunction-Sel PP") # Select 'Noise' function
  field(DLY1, "1")                              # Wait 1 sec
  field(DO2, "1")
  field(LNK2, "$(P)$(R)Span-SP.PROC PP")        # Process span
  field(FLNK, "$(P)$(R)InitSeq2")
}

# Init Carrier Gen parameters

record(sseq, "$(P)$(R)InitSeq2"){
  field(DESC, "Init sequence 2")
  field(SELM, "All")
  field(DO1, "1")
  field(LNK1, "$(P)$(R)CenterFreq-SP.PROC PP") # Process center freq
  field(DO2, "1")
  field(LNK2, "$(P)$(R)Enbl-Sel.PROC PP")      # Process noise and carrier enable
}
