#!/usr/bin/env bash
	
set -u

if [ -z "$TUNE_INSTANCE" ]; then
    echo "TUNE_INSTANCE environment variable is not set." >&2
    exit 1
fi

export TUNE_CURRENT_PV_AREA_PREFIX=TUNE_${TUNE_INSTANCE}_PV_AREA_PREFIX
export TUNE_CURRENT_PV_DEVICE_PREFIX=TUNE_${TUNE_INSTANCE}_PV_DEVICE_PREFIX
export TUNE_CURRENT_NOISE_GEN=TUNE_${TUNE_INSTANCE}_NOISE_GEN
export TUNE_CURRENT_CARRIER_GEN=TUNE_${TUNE_INSTANCE}_CARRIER_GEN
export TUNE_CURRENT_DEVICE_TELNET_PORT=TUNE_${TUNE_INSTANCE}_TELNET_PORT
# Only works with bash
export TUNE_PV_AREA_PREFIX=${!TUNE_CURRENT_PV_AREA_PREFIX}
export TUNE_PV_DEVICE_PREFIX=${!TUNE_CURRENT_PV_DEVICE_PREFIX}
export TUNE_NOISE_GEN=${!TUNE_CURRENT_NOISE_GEN}
export TUNE_CARRIER_GEN=${!TUNE_CURRENT_CARRIER_GEN}
export TUNE_DEVICE_TELNET_PORT=${!TUNE_CURRENT_DEVICE_TELNET_PORT}

if [ -z "${TUNE_DEVICE_TELNET_PORT}" ]; then
    echo "TELNET port is not set." >&2
    exit 1
fi

./runProcServ.sh \
    -t "${TUNE_DEVICE_TELNET_PORT}" \
    -n "${TUNE_NOISE_GEN}" \
    -c "${TUNE_CARRIER_GEN}" \
    -P "${TUNE_PV_AREA_PREFIX}" \
    -R "${TUNE_PV_DEVICE_PREFIX}"

